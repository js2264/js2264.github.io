---
title: Text mining and sentiment analysis in R
author: Jacques Serizay
date: 2020-01-29
slug: text_mining_and_sentiment_analysis_in_R
summary: "In this post, I am going to illustrate how R can be leveraged to do some text mining and will attempt to do basic sentiment analysis."
categories:
    - R
    - Text mining
    - NLP
tags:
    - R
    - Text mining
    - NLP
output:
    blogdown::html_page:
        toc: true
        toc_depth: 1
        number_sections: false
        fig_width: 6
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<div id="pre-processing-lotr-text-in-r" class="section level2">
<h2>Pre-processing LOTR text in R</h2>
<p>Complete LOTR text can be downloaded from Kaggle: <a href="https://www.kaggle.com/ashishsinhaiitr/lord-of-the-rings-text">https://www.kaggle.com/ashishsinhaiitr/lord-of-the-rings-text</a>. I edited the text very quickly, by simply removing the foreword and name of each of the 3 tomes. I also added the “book” II to VI (there was only an entry for “Book I”, the others were missing). Finally, I collated the three tomes together.</p>
<pre class="r"><code>library(tidyverse)</code></pre>
<pre><code>## ── Attaching packages ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── tidyverse 1.3.0 ──</code></pre>
<pre><code>## ✔ ggplot2 3.3.3     ✔ purrr   0.3.4
## ✔ tibble  3.0.5     ✔ dplyr   1.0.3
## ✔ tidyr   1.1.2     ✔ stringr 1.4.0
## ✔ readr   1.4.0     ✔ forcats 0.5.0</code></pre>
<pre><code>## ── Conflicts ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()</code></pre>
<pre class="r"><code>library(magrittr)</code></pre>
<pre><code>## 
## Attaching package: &#39;magrittr&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:purrr&#39;:
## 
##     set_names</code></pre>
<pre><code>## The following object is masked from &#39;package:tidyr&#39;:
## 
##     extract</code></pre>
<pre class="r"><code># -- FUNCTIONS ----------------------
fillUpLines &lt;- function(lines) {
    res &lt;- lapply(1:sum(lines), function(K) {
        value &lt;- which(lines)[K]
        n_reps &lt;- ifelse(
            K &lt; sum(lines),
            which(lines)[K+1] - which(lines)[K],
            length(lines) - which(lines)[K] + 1
        )
        res &lt;- rep(value, n_reps)
        return(res)
    })
    res &lt;- do.call(c, res)
    res &lt;- c(rep(NA, length(lines) - length(res)), res)
    return(res)
}
parseBook &lt;- function(txt_path) {
    txt &lt;- readLines(txt_path) %&gt;%
        tibble(
            line = 1:length(.),
            text = .
        ) %&gt;%
        filter(text != &quot;&quot;) %&gt;%
        mutate(line = 1:nrow(.))
    line_tomes &lt;- txt$text %&gt;% str_detect(&quot;0. - The &quot;)
    line_books &lt;- txt$text %&gt;% str_detect(&quot;BOOK&quot;)
    line_chapters &lt;- txt$text %&gt;% str_detect(&quot;_Chapter&quot;)
    line_chapter_titles &lt;- 1:nrow(txt) %in% {which(line_chapters) + 1}
    txt %&lt;&gt;%
        mutate(text = gsub(&#39;_&#39;, &#39;&#39;, text)) %&gt;%
        mutate(tome = fillUpLines(line_tomes) %&gt;% txt$text[.] %&gt;% gsub(&#39;^\\s+|_&#39;, &#39;&#39;, .)) %&gt;%
        mutate(book = fillUpLines(line_books) %&gt;% txt$text[.] %&gt;% gsub(&#39;^\\s+|_&#39;, &#39;&#39;, .)) %&gt;%
        mutate(chapter = fillUpLines(line_chapters) %&gt;% txt$text[.] %&gt;% gsub(&#39;^\\s+|_&#39;, &#39;&#39;, .)) %&gt;%
        mutate(chapter_title = fillUpLines(line_chapter_titles) %&gt;% txt$text[.] %&gt;% gsub(&#39;^\\s+|_&#39;, &#39;&#39;, .)) %&gt;%
        mutate(raw_text = text) %&gt;%
        mutate(text = gsub(&#39;^\\s+&#39;, &#39;&#39;, raw_text)) %&gt;%
        mutate(nchar = nchar(text))
    txt$entry &lt;- &quot;corpus&quot;
    txt$entry[line_tomes] &lt;- &quot;tome&quot;
    txt$entry[line_books] &lt;- &quot;book&quot;
    txt$entry[line_chapters] &lt;- &quot;chapter&quot;
    txt$entry[line_chapter_titles] &lt;- &quot;chapter_title&quot;
    txt[txt$entry != &#39;corpus&#39;, ] %&lt;&gt;% mutate(book = NA, chapter = NA, chapter_title = NA)
    return(txt)
}
# // FUNCTIONS ----------------------

txt_path &lt;- list.files(&#39;txt&#39;, pattern = &#39;collated&#39;, full.names = TRUE)
LOTR &lt;- parseBook(txt_path)</code></pre>
<p>Let’s have a look at how the different books are structued. This is a nice little tidyverse-assisted data wrangling exercise. First, let’s see how many characters each chapter contains.</p>
<pre class="r"><code>LOTR %&gt;%
    group_by(tome, book, chapter, chapter_title) %&gt;%
    tally(nchar) %&gt;%
    filter(!is.na(chapter) &amp; !is.na(book)) %&gt;%
    ggplot(aes(x = chapter, y = n, fill = chapter)) +
    geom_col() +
    theme_light() +
    facet_wrap(~book, scales = &quot;free&quot;) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
    labs(x = &#39;Chapter&#39;, y = &#39;# of character / chapter&#39;, title = &quot;Number of character per chapter&quot;)</code></pre>
<p><img src="/post/text_mining_and_sentiment_analysis_in_R_files/figure-html/unnamed-chunk-2-1.png" width="576" /></p>
<p>There are some pretty big discrepancies between the length of each chapter in LOTR books. Now, let’s see whether Tolkien was more consistent in the length of paragraphs in each book.</p>
<pre class="r"><code>LOTR %&gt;%
    filter(!is.na(chapter) &amp; !is.na(book)) %&gt;%
    ggplot(aes(x = chapter, y = nchar, fill = chapter)) +
    geom_violin() +
    ggbeeswarm::geom_beeswarm(alpha = 0.2, size = 0.4, fill = NA, col = &#39;black&#39;) +
    geom_boxplot(fill = &#39;white&#39;, width = 0.2, outlier.shape = NA) +
    theme_light() +
    facet_wrap(~book, scales = &quot;free&quot;) +
    scale_y_log10() +
    annotation_logticks(sides = &#39;l&#39;) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
    labs(x = &#39;Chapter&#39;, y = &#39;# of character / paragraph&#39;, title = &quot;Number of character per paragraph&quot;)</code></pre>
<p><img src="/post/text_mining_and_sentiment_analysis_in_R_files/figure-html/unnamed-chunk-3-1.png" width="576" /></p>
<p>Quite interesting: some chapters (especially in Book I) have a stricking bi-modal distribution. Some “paragraphs” look like they are under 100 character each. If you dig into it, you’ll realize that these paragraphs are actually the songs/poems that are mostly found in the first tome of LOTR, notably when the hobbits encounter Tom Bombabil (one of my favorite chapters in the entire saga!).</p>
<p>Let’s confirm this quickly. After visual inspection of the text file, the songs mostly start with a repetition of 10 to 12 spaces (<code></code>).</p>
<pre class="r"><code>bool &lt;- grepl(&quot;^          [a-zA-Z]|^           [a-zA-Z]|^            [a-zA-Z]&quot;, LOTR$raw_text)
LOTR[bool &amp; LOTR$entry == &quot;corpus&quot;, &quot;entry&quot;] &lt;- &quot;song&quot;
LOTR %&gt;%
    filter(!is.na(chapter) &amp; !is.na(book)) %&gt;%
    ggplot(aes(x = chapter, y = nchar, fill = chapter)) +
    ggbeeswarm::geom_beeswarm(
        alpha = 0.4,
        size = 0.6,
        fill = NA,
        aes(col = entry)
    ) +
    theme_light() +
    facet_wrap(~book, scales = &quot;free&quot;) +
    scale_y_log10() +
    annotation_logticks(sides = &#39;l&#39;) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
    labs(x = &#39;Chapter&#39;, y = &#39;# of character / paragraph&#39;, title = &quot;Number of character per paragraph&quot;)</code></pre>
<p><img src="/post/text_mining_and_sentiment_analysis_in_R_files/figure-html/unnamed-chunk-4-1.png" width="576" /></p>
</div>
<div id="converting-the-tibble-into-an-even-tidier-format-with-tidytext" class="section level2">
<h2>Converting the tibble into an even tidier format with <code>tidytext</code></h2>
<p>The <code>tidytext</code> package is very useful to transform a tibble containing strings into a tidier tibble, with only 1 word per row. This is done with the <code>unnest_tokens()</code> function:</p>
<pre class="r"><code>library(tidytext)
LOTR</code></pre>
<pre><code>## # A tibble: 9,162 x 9
##     line text       tome    book  chapter chapter_title raw_text     nchar entry
##    &lt;int&gt; &lt;chr&gt;      &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;         &lt;chr&gt;        &lt;int&gt; &lt;chr&gt;
##  1     1 01 - The … 01 - T… &lt;NA&gt;  &lt;NA&gt;    &lt;NA&gt;          &quot;          …    31 tome 
##  2     2 BOOK I     01 - T… &lt;NA&gt;  &lt;NA&gt;    &lt;NA&gt;          &quot;          …     6 book 
##  3     3 Chapter 01 01 - T… &lt;NA&gt;  &lt;NA&gt;    &lt;NA&gt;          &quot;          …    10 chap…
##  4     4 A Long-ex… 01 - T… &lt;NA&gt;  &lt;NA&gt;    &lt;NA&gt;          &quot;          …    21 chap…
##  5     5 When Mr. … 01 - T… BOOK… Chapte… A Long-expec… &quot;     When …   194 corp…
##  6     6 Bilbo was… 01 - T… BOOK… Chapte… A Long-expec… &quot;     Bilbo…   868 corp…
##  7     7 &#39;It will … 01 - T… BOOK… Chapte… A Long-expec… &quot;     &#39;It w…    90 corp…
##  8     8 But so fa… 01 - T… BOOK… Chapte… A Long-expec… &quot;     But s…   416 corp…
##  9     9 The eldes… 01 - T… BOOK… Chapte… A Long-expec… &quot;     The e…   580 corp…
## 10    10 Twelve mo… 01 - T… BOOK… Chapte… A Long-expec… &quot;     Twelv…   451 corp…
## # … with 9,152 more rows</code></pre>
<pre class="r"><code>LOTR %&gt;%
    unnest_tokens(word, text)</code></pre>
<pre><code>## # A tibble: 471,247 x 9
##     line tome      book  chapter chapter_title raw_text        nchar entry word 
##    &lt;int&gt; &lt;chr&gt;     &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;         &lt;chr&gt;           &lt;int&gt; &lt;chr&gt; &lt;chr&gt;
##  1     1 01 - The… &lt;NA&gt;  &lt;NA&gt;    &lt;NA&gt;          &quot;             …    31 tome  01   
##  2     1 01 - The… &lt;NA&gt;  &lt;NA&gt;    &lt;NA&gt;          &quot;             …    31 tome  the  
##  3     1 01 - The… &lt;NA&gt;  &lt;NA&gt;    &lt;NA&gt;          &quot;             …    31 tome  fell…
##  4     1 01 - The… &lt;NA&gt;  &lt;NA&gt;    &lt;NA&gt;          &quot;             …    31 tome  of   
##  5     1 01 - The… &lt;NA&gt;  &lt;NA&gt;    &lt;NA&gt;          &quot;             …    31 tome  the  
##  6     1 01 - The… &lt;NA&gt;  &lt;NA&gt;    &lt;NA&gt;          &quot;             …    31 tome  ring 
##  7     2 01 - The… &lt;NA&gt;  &lt;NA&gt;    &lt;NA&gt;          &quot;             …     6 book  book 
##  8     2 01 - The… &lt;NA&gt;  &lt;NA&gt;    &lt;NA&gt;          &quot;             …     6 book  i    
##  9     3 01 - The… &lt;NA&gt;  &lt;NA&gt;    &lt;NA&gt;          &quot;             …    10 chap… chap…
## 10     3 01 - The… &lt;NA&gt;  &lt;NA&gt;    &lt;NA&gt;          &quot;             …    10 chap… 01   
## # … with 471,237 more rows</code></pre>
<p>To illustrate the use of <code>tidytext</code> and how well it can be used with <code>tidyverse</code>-related tools, we can count how many times each character is named in each chapter:</p>
<pre class="r"><code>characters &lt;- c(&#39;frodo&#39;, &#39;sam&#39;, &#39;gandalf&#39;, &#39;aragorn&#39;, &#39;pippin&#39;, &#39;merry&#39;, &#39;gimli&#39;, &#39;legolas&#39;, &#39;gollum&#39;, &#39;bilbo&#39;)
LOTR %&gt;%
    unnest_tokens(word, text) %&gt;%
    filter(!is.na(chapter) &amp; !is.na(book)) %&gt;%
    filter(word %in% characters) %&gt;%
    mutate(word = factor(word, characters)) %&gt;%
    count(tome, book, chapter, chapter_title, word) %&gt;%
    ggplot(aes(x = chapter, y = n, fill = chapter)) +
    geom_col() +
    theme_light() +
    facet_grid(word~book, scales = &quot;free&quot;) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
    labs(x = &#39;Chapter&#39;, y = &#39;# of character citations&#39;, title = &quot;Number of times each protagonist is named&quot;)</code></pre>
<p><img src="/post/text_mining_and_sentiment_analysis_in_R_files/figure-html/unnamed-chunk-6-1.png" width="576" /></p>
<p>I love this figure. In just a few lines of code, the number of times each protagonist is named, in each chapter of each book, is computed and beautifully plotted. Just looking at this figure, I could tell what happens in each chapter:</p>
<ul>
<li>Book III, chapters 2 and 3 are most likely about Merry and Pippins when they are captured by the Orcs;</li>
<li>In Book V, Chapter 4, Pippin and Gandalf are together, defending Minas Tirith;</li>
<li>The return of Gollum in the third chapter of Book 6 signs the achievement of the quest with Gollum falling into the Cracks of Doom.</li>
</ul>
<p>And here is another type of representation of the # of occurence of each protagonist. The input data.frame stays the same, I’ve just changed a tiny bit the ggplot2 geometries, et voila!</p>
<pre class="r"><code>characters &lt;- c(&#39;frodo&#39;, &#39;sam&#39;, &#39;gandalf&#39;, &#39;aragorn&#39;, &#39;pippin&#39;, &#39;merry&#39;, &#39;gimli&#39;, &#39;legolas&#39;, &#39;gollum&#39;, &#39;bilbo&#39;)
LOTR %&gt;%
    unnest_tokens(word, text) %&gt;%
    filter(!is.na(chapter) &amp; !is.na(book)) %&gt;%
    filter(word %in% characters) %&gt;%
    mutate(word = factor(word, characters)) %&gt;%
    count(tome, book, chapter, chapter_title, word) %&gt;%
    ggplot(aes(x = chapter, y = n, fill = word)) +
    geom_col(position = &#39;fill&#39;) +
    facet_grid(~book, scales = &quot;free&quot;) +
    theme_light() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
    labs(x = &#39;Chapter&#39;, y = &#39;# of character citations&#39;, title = &quot;Number of times each protagonist is named&quot;)</code></pre>
<p><img src="/post/text_mining_and_sentiment_analysis_in_R_files/figure-html/unnamed-chunk-7-1.png" width="576" /></p>
</div>
<div id="character-networks" class="section level2">
<h2>Character networks</h2>
<p>TBD</p>
</div>
<div id="a-bit-of-sentiment-analysis" class="section level2">
<h2>A bit of sentiment analysis</h2>
<p>To find the most used non-stop words, one can (1) remove the “stop” words (as defined in the <code>stop_words</code> object), then (2) count the occurence of the remaining words. <code>tidytext</code> and <code>tidyverse</code> are, again, very useful to perform this:</p>
<pre class="r"><code>data(stop_words)
top_words &lt;- LOTR %&gt;%
    unnest_tokens(word, text) %&gt;%
    anti_join(stop_words) %&gt;%
    count(book, word, sort = TRUE) %&gt;%
    filter(book %in% &quot;BOOK VI&quot;) %&gt;%
    top_n(100) %&gt;%
    pull(word)</code></pre>
<pre><code>## Joining, by = &quot;word&quot;</code></pre>
<pre><code>## Selecting by n</code></pre>
<pre class="r"><code>top_words</code></pre>
<pre><code>##   [1] &quot;sam&quot;      &quot;frodo&quot;    &quot;dark&quot;     &quot;merry&quot;    &quot;road&quot;     &quot;time&quot;    
##   [7] &quot;looked&quot;   &quot;gandalf&quot;  &quot;hand&quot;     &quot;eyes&quot;     &quot;stood&quot;    &quot;day&quot;     
##  [13] &quot;hobbits&quot;  &quot;light&quot;    &quot;orc&quot;      &quot;passed&quot;   &quot;black&quot;    &quot;king&quot;    
##  [19] &quot;land&quot;     &quot;ring&quot;     &quot;left&quot;     &quot;days&quot;     &quot;folk&quot;     &quot;gate&quot;    
##  [25] &quot;heard&quot;    &quot;shire&quot;    &quot;west&quot;     &quot;set&quot;      &quot;night&quot;    &quot;tower&quot;   
##  [31] &quot;master&quot;   &quot;pippin&quot;   &quot;white&quot;    &quot;aragorn&quot;  &quot;cried&quot;    &quot;round&quot;   
##  [37] &quot;faramir&quot;  &quot;grey&quot;     &quot;hope&quot;     &quot;mordor&quot;   &quot;ran&quot;      &quot;ruffians&quot;
##  [43] &quot;rode&quot;     &quot;water&quot;    &quot;fell&quot;     &quot;north&quot;    &quot;head&quot;     &quot;rose&quot;    
##  [49] &quot;hear&quot;     &quot;shadow&quot;   &quot;city&quot;     &quot;coming&quot;   &quot;dead&quot;     &quot;hands&quot;   
##  [55] &quot;voice&quot;    &quot;found&quot;    &quot;mountain&quot; &quot;fire&quot;     &quot;lord&quot;     &quot;deep&quot;    
##  [61] &quot;lay&quot;      &quot;door&quot;     &quot;drew&quot;     &quot;east&quot;     &quot;fear&quot;     &quot;feet&quot;    
##  [67] &quot;gondor&quot;   &quot;red&quot;      &quot;sun&quot;      &quot;fair&quot;     &quot;heart&quot;    &quot;owyn&quot;    
##  [73] &quot;sat&quot;      &quot;wind&quot;     &quot;cotton&quot;   &quot;lady&quot;     &quot;stone&quot;    &quot;suddenly&quot;
##  [79] &quot;moment&quot;   &quot;slowly&quot;   &quot;leave&quot;    &quot;mind&quot;     &quot;people&quot;   &quot;darkness&quot;
##  [85] &quot;orcs&quot;     &quot;saruman&quot;  &quot;bag&quot;      &quot;bit&quot;      &quot;brought&quot;  &quot;silver&quot;  
##  [91] &quot;south&quot;    &quot;trees&quot;    &quot;walls&quot;    &quot;world&quot;    &quot;rohan&quot;    &quot;wall&quot;    
##  [97] &quot;chief&quot;    &quot;green&quot;    &quot;sword&quot;    &quot;bilbo&quot;    &quot;country&quot;  &quot;doom&quot;    
## [103] &quot;path&quot;     &quot;save&quot;</code></pre>
<p>I really like this list of top words. It clearly shows already that there are conflicting feelings in LOTR: we have <code>fear</code> opposing <code>hope</code>, <code>light</code> versus <code>dark</code>, and even temporal contrasts with <code>day</code> and <code>night</code>…</p>
<pre class="r"><code>LOTR %&gt;%
    filter(!is.na(chapter) &amp; !is.na(book)) %&gt;%
    unnest_tokens(word, text) %&gt;%
    filter(word %in% top_words) %&gt;%
    mutate(chapter_title = factor(chapter_title, unique(chapter_title))) %&gt;%
    mutate(word = factor(word, top_words)) %&gt;%
    filter(book %in% &quot;BOOK VI&quot;) %&gt;%
    count(chapter_title, word) %&gt;%
    ggplot(aes(x = word, y = n)) +
    geom_col() +
    facet_grid(~chapter_title, scales = &quot;free&quot;) +
    coord_flip() +
    theme_light() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
    labs(x = &#39;Top words&#39;, y = &#39;# of occurences&#39;, title = &quot;Number of times each word is mentionned&quot;) +
    theme(text = element_text(size = 6))</code></pre>
<p><img src="/post/text_mining_and_sentiment_analysis_in_R_files/figure-html/unnamed-chunk-9-1.png" width="576" /></p>
<p>Ideally, one would want to re-organize terms based on how they occur.</p>
<pre class="r"><code>words_order &lt;- LOTR %&gt;%
    filter(!is.na(chapter) &amp; !is.na(book)) %&gt;%
    unnest_tokens(word, text) %&gt;%
    filter(word %in% top_words) %&gt;%
    mutate(word = factor(word, top_words)) %&gt;%
    filter(book %in% &quot;BOOK VI&quot;) %&gt;%
    count(chapter_title, word) %&gt;%
    spread(word, n) %&gt;%
    column_to_rownames(&#39;chapter_title&#39;) %&gt;%
    t() %&gt;%
    replace_na(0) %&gt;%
    dist() %&gt;%
    hclust() %$%
    order %&gt;%
    top_words[.]</code></pre>
<pre class="r"><code>LOTR %&gt;%
    filter(!is.na(chapter) &amp; !is.na(book)) %&gt;%
    unnest_tokens(word, text) %&gt;%
    filter(word %in% top_words) %&gt;%
    mutate(word = factor(word, words_order)) %&gt;%
    filter(book %in% &quot;BOOK VI&quot;) %&gt;%
    count(chapter_title, word) %&gt;%
    ggplot(aes(x = word, y = n)) +
    geom_col() +
    facet_grid(~chapter_title, scales = &quot;free&quot;) +
    coord_flip() +
    theme_light() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
    labs(x = &#39;Top words&#39;, y = &#39;# of occurences&#39;, title = &quot;Number of times each word is mentionned&quot;) +
    theme(text = element_text(size = 6))</code></pre>
<p><img src="/post/text_mining_and_sentiment_analysis_in_R_files/figure-html/unnamed-chunk-11-1.png" width="576" /></p>
<p>By re-ordering the words, we can clearly see that words describing the hobbits heading back the the Shire are grouped together, while humans returning to the Gondor form another cluster, and orcs and the Mordor in a last separate clique.</p>
<p>Let’s now focus on sentiment analysis. We can get the <code>NRC</code> sentiment lexicon published by Mohammad, Saif M. and Turney, Peter D. in 2013.</p>
<pre class="r"><code>sentiment_words &lt;- get_sentiments(&quot;nrc&quot;)
sentiments &lt;- LOTR %&gt;%
    filter(!is.na(chapter) &amp; !is.na(book)) %&gt;%
    unnest_tokens(word, text) %&gt;%
    group_by(book) %&gt;%
    mutate(progression = as.integer(cut(1:n(), 100))) %&gt;%
    group_by(book, progression) %&gt;%
    inner_join(sentiment_words) %&gt;%
    count(book, sentiment)</code></pre>
<pre><code>## Joining, by = &quot;word&quot;</code></pre>
<pre class="r"><code>sentiments %&gt;%
    filter(sentiment %in% c(&#39;positive&#39;, &#39;negative&#39;)) %&gt;%
    ggplot(aes(x = progression, y = n, fill = sentiment)) +
    geom_col() +
    facet_grid(book~sentiment, scales = &quot;free&quot;) +
    theme_light() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
    labs(x = &#39;Chapter&#39;, y = &#39;Number of occurences&#39;, title = &#39;Number of times a word occurs&#39;)</code></pre>
<p><img src="/post/text_mining_and_sentiment_analysis_in_R_files/figure-html/unnamed-chunk-12-1.png" width="576" /></p>
<p>We can focus on Book VI for a bit, with more of the sentiments described by the <code>NCR</code> lexicon:</p>
<pre class="r"><code>sentiments_bookVI &lt;- LOTR %&gt;%
    filter(!is.na(chapter) &amp; !is.na(book)) %&gt;%
    unnest_tokens(word, text) %&gt;%
    filter(book == &#39;BOOK VI&#39;) %&gt;%
    mutate(progression = as.integer(cut(1:n(), 100))) %&gt;%
    group_by(progression) %&gt;%
    inner_join(sentiment_words) %&gt;%
    count(sentiment)</code></pre>
<pre><code>## Joining, by = &quot;word&quot;</code></pre>
<pre class="r"><code>sentiments_bookVI %&gt;%
    ggplot(aes(x = progression, y = n, fill = sentiment), col = NA) +
    geom_col() +
    geom_vline(aes(xintercept = 37), col = &#39;black&#39;, linetype = &#39;dashed&#39;, size = 0.5) +
    geom_vline(aes(xintercept = 75), col = &#39;black&#39;, linetype = &#39;dashed&#39;, size = 0.5) +
    facet_grid(sentiment~., scales = &quot;free&quot;) +
    theme_light() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
    labs(x = &#39;Progression through book VI&#39;, y = &#39;Sentiment score&#39;, title = &#39;Sentiment analysis of Book VI&#39;)</code></pre>
<p><img src="/post/text_mining_and_sentiment_analysis_in_R_files/figure-html/unnamed-chunk-13-1.png" width="576" /></p>
<p>The different sentiments highlight the different key events occuring in the Book VI. For instance:</p>
<ul>
<li>At the first third of Book VI: Frodo and Sam reach the Cracks of Doom. It is a pretty dark moment of despair, exhaustion and depression. Yet, it signs the end of all these feelings and the return of hope and joy.</li>
<li>At the three quarters of Book VI, the Company arrives in Bree and Frodo recalls his long adventures. It is a happy moment with friends gathering in a safe and known place.</li>
</ul>
</div>
<div id="conclusion" class="section level2">
<h2>Conclusion</h2>
<p>This post shows how the <code>tidyverse</code> can be extended to text mining, thanks to the <code>tidytext</code> package. By keeping things tidy, neat analyses and powerful visualization can be obtained very easily, in few lines of code.</p>
</div>
